<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Brillar API Testing Sandbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="material-theme.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    body.api-test {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: #f6f8fb;
      color: #1f2933;
    }
    .api-test__header {
      background: linear-gradient(135deg, #2d6cdf, #7b5cff);
      color: #fff;
      padding: 2.5rem 1.5rem;
      text-align: center;
      box-shadow: 0 4px 16px rgba(37, 56, 88, 0.2);
    }
    .api-test__header h1 {
      margin: 0 0 0.5rem;
      font-size: 2rem;
      font-weight: 600;
    }
    .api-test__header p {
      margin: 0 auto;
      max-width: 640px;
      line-height: 1.5;
    }
    .api-test__content {
      max-width: 960px;
      margin: -2.5rem auto 3rem;
      padding: 0 1rem;
    }
    .api-test__card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    .api-test__card h2 {
      margin-top: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .api-test__card h2 span.material-symbols-rounded {
      font-size: 1.6rem;
    }
    .api-test__description {
      margin-top: 0.25rem;
      color: #52616b;
      line-height: 1.6;
    }
    .api-test__form {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .api-test__form .md-field {
      margin: 0;
    }
    .api-test__stack {
      display: grid;
      gap: 1rem;
    }
    .api-test__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }
    pre.api-test__pre {
      background: #0f172a;
      color: #e3f2fd;
      padding: 1rem;
      border-radius: 12px;
      overflow-x: auto;
      font-size: 0.9rem;
      max-height: 240px;
    }
    code.api-test__code-inline {
      background: rgba(45, 108, 223, 0.12);
      padding: 0.1rem 0.25rem;
      border-radius: 6px;
      font-size: 0.9em;
    }
    .api-test__status {
      font-weight: 500;
    }
    .api-test__status--success {
      color: #147d64;
    }
    .api-test__status--error {
      color: #c81e1e;
    }
    .api-test__footer {
      text-align: center;
      color: #6b7280;
      padding: 2rem 1rem 3rem;
      font-size: 0.9rem;
    }
    textarea.api-test__token {
      width: 100%;
      min-height: 70px;
      padding: 0.75rem;
      border-radius: 12px;
      border: 1px solid #d2d6dc;
      font-family: 'Roboto Mono', monospace;
      font-size: 0.95rem;
      resize: vertical;
    }
    textarea.api-test__token--body {
      min-height: 140px;
    }
    .api-test__grid {
      display: grid;
      gap: 1.5rem;
    }
    .api-test__note {
      margin: 0;
      color: #52616b;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .api-test__note strong {
      color: #1f2933;
    }
    .api-test__note em {
      font-style: normal;
      color: #7b5cff;
      font-weight: 500;
    }
    @media (min-width: 720px) {
      .api-test__two-column {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1.5rem;
      }
    }
  </style>
</head>
<body class="api-test">
  <header class="api-test__header">
    <h1>Brillar API Testing Sandbox</h1>
    <p>Validate authentication and protected endpoints without leaving your browser. Use this page to mint a token, call
      <code class="api-test__code-inline">/api/me</code>, and share ready-to-run <code class="api-test__code-inline">curl</code> commands with embedded teams.</p>
  </header>

  <main class="api-test__content">
    <section class="api-test__card">
      <h2><span class="material-symbols-rounded">public</span>Environment setup</h2>
      <p class="api-test__description">Confirm where your API is running. By default the portal is served from
        <code class="api-test__code-inline">http://localhost:3000</code> when launched locally.</p>
      <div class="api-test__form">
        <div class="md-field">
          <label class="md-label" for="baseUrl">API base URL</label>
          <div class="md-input-wrapper">
            <span class="material-symbols-rounded">link</span>
            <input class="md-input" id="baseUrl" type="url" required placeholder="http://localhost:3000">
          </div>
        </div>
      </div>
    </section>

    <section class="api-test__card">
      <h2><span class="material-symbols-rounded">login</span>Authenticate</h2>
      <p class="api-test__description">Use a valid email/password pair (for example the seeded
        <code class="api-test__code-inline">admin@brillar.io</code> account) to call <code class="api-test__code-inline">POST /login</code>.</p>
      <form id="apiTestLoginForm" class="api-test__form">
        <div class="api-test__two-column">
          <div class="md-field">
            <label class="md-label" for="loginEmail">Email</label>
            <div class="md-input-wrapper">
              <span class="material-symbols-rounded">mail</span>
              <input class="md-input" id="loginEmail" type="email" required placeholder="admin@brillar.io">
            </div>
          </div>
          <div class="md-field">
            <label class="md-label" for="loginPassword">Password</label>
            <div class="md-input-wrapper">
              <span class="material-symbols-rounded">lock</span>
              <input class="md-input" id="loginPassword" type="password" required placeholder="admin">
            </div>
          </div>
        </div>
        <div class="api-test__actions">
          <button type="submit" class="md-button md-button--filled" id="loginSubmitBtn">
            <span class="material-symbols-rounded">play_arrow</span>
            Send login request
          </button>
          <span id="loginStatus" class="api-test__status"></span>
        </div>
      </form>
      <pre class="api-test__pre" id="loginOutput" aria-live="polite">Awaiting login request…</pre>
    </section>

    <section class="api-test__card">
      <h2><span class="material-symbols-rounded">key</span>Bearer token</h2>
      <p class="api-test__description">The sandbox stores the most recent token from the login response. You can also paste a
        token manually to test other accounts.</p>
      <div class="api-test__grid">
        <textarea id="tokenField" class="api-test__token" placeholder="Authenticate above or paste an existing token"></textarea>
        <div class="api-test__actions">
          <button type="button" class="md-button md-button--outlined md-button--small" id="copyTokenBtn">
            <span class="material-symbols-rounded">content_copy</span>
            Copy token
          </button>
          <span id="tokenStatus" class="api-test__status"></span>
        </div>
      </div>
    </section>

    <section class="api-test__card">
      <h2><span class="material-symbols-rounded">manage_accounts</span>Call protected routes</h2>
      <p class="api-test__description">Send requests with the token injected into an <code class="api-test__code-inline">Authorization: Bearer &lt;token&gt;</code> header. Pick any of the available endpoints below or create a custom request.</p>
      <form id="requestForm" class="api-test__form">
        <div class="api-test__stack">
          <label class="md-label" for="endpointPicker">Endpoint preset</label>
          <select class="md-input" id="endpointPicker"></select>
          <p id="endpointDetails" class="api-test__note"></p>
        </div>
        <div class="api-test__two-column">
          <div class="md-field">
            <label class="md-label" for="requestMethod">HTTP method</label>
            <div class="md-input-wrapper">
              <span class="material-symbols-rounded">swap_vert</span>
              <select class="md-input" id="requestMethod">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
              </select>
            </div>
          </div>
          <div class="md-field">
            <label class="md-label" for="requestEndpoint">Endpoint path</label>
            <div class="md-input-wrapper">
              <span class="material-symbols-rounded">share</span>
              <input class="md-input" id="requestEndpoint" type="text" required value="/api/me">
            </div>
          </div>
        </div>
        <div class="api-test__stack">
          <label class="md-label" for="requestBody">JSON body (optional)</label>
          <textarea id="requestBody" class="api-test__token api-test__token--body" placeholder="Provide a JSON payload for POST/PUT requests"></textarea>
        </div>
        <div class="api-test__actions">
          <button type="submit" class="md-button md-button--filled" id="requestSubmitBtn">
            <span class="material-symbols-rounded">play_arrow</span>
            Send request
          </button>
          <span id="requestStatus" class="api-test__status"></span>
        </div>
      </form>
      <pre class="api-test__pre" id="requestOutput" aria-live="polite">Awaiting request…</pre>
    </section>

    <section class="api-test__card">
      <h2><span class="material-symbols-rounded">code</span>Shareable curl command</h2>
      <p class="api-test__description">Hand this to anyone integrating with the widget. It includes the current token so the command mirrors the request above.</p>
      <div class="api-test__grid">
        <pre class="api-test__pre" id="curlCommand">Authenticate to generate a curl command.</pre>
        <div class="api-test__actions">
          <button type="button" class="md-button md-button--outlined md-button--small" id="copyCurlBtn">
            <span class="material-symbols-rounded">content_copy</span>
            Copy curl command
          </button>
          <span id="curlStatus" class="api-test__status"></span>
        </div>
      </div>
    </section>
  </main>

  <footer class="api-test__footer">
    Tip: the sandbox never stores credentials. Refresh the page to clear the session and remove the token.
  </footer>

  <script>
    const state = {
      token: '',
      baseUrl: window.location.origin,
      selectedEndpointId: 'me',
      lastAppliedSample: ''
    };

    const baseUrlInput = document.getElementById('baseUrl');
    const loginForm = document.getElementById('apiTestLoginForm');
    const loginOutput = document.getElementById('loginOutput');
    const loginStatus = document.getElementById('loginStatus');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    const tokenField = document.getElementById('tokenField');
    const tokenStatus = document.getElementById('tokenStatus');
    const copyTokenBtn = document.getElementById('copyTokenBtn');
    const endpointPicker = document.getElementById('endpointPicker');
    const endpointDetails = document.getElementById('endpointDetails');
    const requestForm = document.getElementById('requestForm');
    const requestMethod = document.getElementById('requestMethod');
    const requestEndpoint = document.getElementById('requestEndpoint');
    const requestBodyField = document.getElementById('requestBody');
    const requestOutput = document.getElementById('requestOutput');
    const requestStatus = document.getElementById('requestStatus');
    const requestSubmitBtn = document.getElementById('requestSubmitBtn');
    const curlCommand = document.getElementById('curlCommand');
    const copyCurlBtn = document.getElementById('copyCurlBtn');
    const curlStatus = document.getElementById('curlStatus');

    const searchParams = new URLSearchParams(window.location.search);
    const tokenParamOrder = ['bearer', 'token', 'selfBearerToken'];
    let tokenFromQuery = '';
    for (const key of tokenParamOrder) {
      const candidate = searchParams.get(key);
      if (candidate && candidate.trim()) {
        tokenFromQuery = candidate.trim();
        break;
      }
    }
    if (tokenFromQuery) {
      setToken(tokenFromQuery, { statusMessage: 'Token supplied via URL query' });
      try {
        const cleanUrl = `${window.location.pathname}${window.location.hash || ''}`;
        window.history.replaceState({}, document.title, cleanUrl);
      } catch (err) {
        // Non-fatal: best effort cleanup of the token-bearing URL.
      }
    }

    const endpointDefinitions = [
      {
        id: 'me',
        label: 'GET /api/me',
        method: 'GET',
        path: '/api/me',
        description: 'Returns the authenticated account ID, linked employee ID, email, and role.'
      },
      {
        id: 'myProfile',
        label: 'GET /api/my-profile',
        method: 'GET',
        path: '/api/my-profile',
        description: 'Fetches the detailed profile for the signed-in employee, grouped by section.'
      },
      {
        id: 'updateProfile',
        label: 'PUT /api/my-profile',
        method: 'PUT',
        path: '/api/my-profile',
        description: 'Update editable personal or contact details for the current employee.',
        sampleBody: {
          updates: {
            address: '123 Updated Avenue, Springfield',
            mobile: '+1 555 0100'
          }
        }
      },
      {
        id: 'leaveSummary',
        label: 'GET /api/leave-summary',
        method: 'GET',
        path: '/api/leave-summary',
        description: 'Summarises leave balances and historical usage. Managers can add ?employeeId= to inspect another employee.'
      },
      {
        id: 'applyLeave',
        label: 'POST /api/leaves',
        method: 'POST',
        path: '/api/leaves',
        description: 'Submit a leave application. Managers can submit on behalf of their team.',
        sampleBody: {
          employeeId: 1,
          type: 'annual',
          from: '2024-01-15',
          to: '2024-01-17',
          reason: 'Family travel'
        }
      },
      {
        id: 'holidays',
        label: 'GET /holidays',
        method: 'GET',
        path: '/holidays',
        description: 'Lists configured company holidays for quick reference.'
      },
      {
        id: 'createHoliday',
        label: 'POST /holidays',
        method: 'POST',
        path: '/holidays',
        description: 'Managers can add a holiday to the shared calendar.',
        sampleBody: {
          date: '2024-12-25',
          name: 'Christmas Day'
        },
        requiresManager: true
      },
      {
        id: 'listEmployees',
        label: 'GET /employees',
        method: 'GET',
        path: '/employees',
        description: 'Managers see the full directory; employees only see themselves.',
        requiresManager: true
      },
      {
        id: 'createEmployee',
        label: 'POST /employees',
        method: 'POST',
        path: '/employees',
        description: 'Managers can create a new employee record and matching login.',
        sampleBody: {
          name: 'New Teammate',
          email: 'new.hire@example.com',
          department: 'Engineering',
          role: 'employee',
          status: 'active'
        },
        requiresManager: true
      },
      {
        id: 'positions',
        label: 'GET /recruitment/positions',
        method: 'GET',
        path: '/recruitment/positions',
        description: 'Managers can review open recruitment positions.',
        requiresManager: true
      },
      {
        id: 'candidates',
        label: 'GET /recruitment/candidates',
        method: 'GET',
        path: '/recruitment/candidates',
        description: 'Managers can browse submitted candidates.',
        requiresManager: true
      },
      {
        id: 'custom',
        label: 'Custom request',
        method: 'GET',
        path: '/api/me',
        description: 'Manually configure the method, path, and body to explore any endpoint.',
        custom: true
      }
    ];

    function methodSupportsBody(method) {
      const normalized = (method || 'GET').toUpperCase();
      return !['GET', 'HEAD'].includes(normalized);
    }

    function buildEndpointNote(def) {
      if (!def) return '';
      const details = [`<strong>${def.method} ${def.path}</strong>`];
      if (def.description) {
        details.push(def.description);
      }
      if (def.requiresManager) {
        details.push('<em>Manager role required</em>');
      }
      if (def.sampleBody && !def.custom) {
        details.push('Sample payload pre-filled below.');
      }
      return details.join(' ');
    }

    function updateRequestBodyPlaceholder() {
      const method = (requestMethod.value || 'GET').toUpperCase();
      if (methodSupportsBody(method)) {
        requestBodyField.placeholder = 'Provide a JSON payload for POST/PUT requests';
      } else {
        requestBodyField.placeholder = 'GET requests typically do not include a body';
      }
    }

    function applyEndpoint(def) {
      if (!def) return;
      state.selectedEndpointId = def.id;
      endpointDetails.innerHTML = buildEndpointNote(def);
      if (def.custom) {
        state.lastAppliedSample = '';
        updateRequestBodyPlaceholder();
        updateCurlCommand();
        return;
      }
      requestMethod.value = def.method || 'GET';
      requestEndpoint.value = def.path || '/';
      updateRequestBodyPlaceholder();
      if (def.sampleBody) {
        const sample = typeof def.sampleBody === 'string'
          ? def.sampleBody
          : JSON.stringify(def.sampleBody, null, 2);
        requestBodyField.value = sample;
        state.lastAppliedSample = sample.trim();
      } else {
        requestBodyField.value = '';
        state.lastAppliedSample = '';
      }
      updateCurlCommand();
    }

    function populateEndpointOptions() {
      endpointPicker.innerHTML = '';
      endpointDefinitions.forEach(def => {
        const option = document.createElement('option');
        option.value = def.id;
        option.textContent = `${def.label}${def.requiresManager ? ' (manager)' : ''}`;
        endpointPicker.appendChild(option);
      });
      const initial = endpointDefinitions[0];
      endpointPicker.value = initial.id;
      applyEndpoint(initial);
    }

    function resetStatus(el) {
      if (!el) return;
      el.textContent = '';
      el.classList.remove('api-test__status--success', 'api-test__status--error');
    }

    function setStatus(el, message, type = 'info') {
      if (!el) return;
      el.textContent = message;
      el.classList.remove('api-test__status--success', 'api-test__status--error');
      if (type === 'success') el.classList.add('api-test__status--success');
      if (type === 'error') el.classList.add('api-test__status--error');
    }

    function setToken(token, options = {}) {
      state.token = token || '';
      tokenField.value = state.token;
      if (state.token) {
        const message = options.statusMessage || 'Token ready for use';
        setStatus(tokenStatus, message, 'success');
      } else {
        setStatus(tokenStatus, 'Token cleared');
      }
      updateCurlCommand();
    }

    function updateCurlCommand() {
      if (!state.token) {
        curlCommand.textContent = 'Authenticate to generate a curl command.';
        return;
      }
      const method = (requestMethod.value || 'GET').toUpperCase();
      const endpoint = requestEndpoint.value.trim() || '/api/me';
      const url = new URL(endpoint, state.baseUrl).toString();
      let command = `curl -X ${method} "${url}" -H "Authorization: Bearer ${state.token}"`;
      const bodyText = requestBodyField.value.trim();
      if (methodSupportsBody(method) && bodyText) {
        let jsonString = bodyText;
        try {
          jsonString = JSON.stringify(JSON.parse(bodyText));
        } catch (err) {
          // Leave the body as-is; the submit handler will prevent invalid JSON from being sent.
        }
        const escaped = jsonString.replace(/'/g, "'\\''");
        command += ` -H "Content-Type: application/json" -d '${escaped}'`;
      }
      curlCommand.textContent = command;
    }

    function getBaseUrl() {
      try {
        const value = baseUrlInput.value.trim();
        if (!value) return state.baseUrl;
        const url = new URL(value);
        return url.origin;
      } catch (err) {
        return state.baseUrl;
      }
    }

    function prettify(data) {
      if (typeof data === 'string') return data;
      try {
        return JSON.stringify(data, null, 2);
      } catch (err) {
        return String(data);
      }
    }

    baseUrlInput.value = state.baseUrl;

    populateEndpointOptions();
    updateRequestBodyPlaceholder();

    baseUrlInput.addEventListener('change', () => {
      state.baseUrl = getBaseUrl();
      updateCurlCommand();
    });

    tokenField.addEventListener('input', () => {
      state.token = tokenField.value.trim();
      updateCurlCommand();
      if (state.token) {
        setStatus(tokenStatus, 'Using manually supplied token', 'success');
      } else {
        resetStatus(tokenStatus);
      }
    });

    copyTokenBtn.addEventListener('click', async () => {
      if (!state.token) {
        setStatus(tokenStatus, 'No token to copy', 'error');
        return;
      }
      try {
        await navigator.clipboard.writeText(state.token);
        setStatus(tokenStatus, 'Token copied to clipboard', 'success');
      } catch (err) {
        setStatus(tokenStatus, 'Clipboard copy failed. Copy manually instead.', 'error');
      }
    });

    copyCurlBtn.addEventListener('click', async () => {
      const command = curlCommand.textContent.trim();
      if (!command || command.startsWith('Authenticate')) {
        setStatus(curlStatus, 'Generate a command first', 'error');
        return;
      }
      try {
        await navigator.clipboard.writeText(command);
        setStatus(curlStatus, 'curl command copied', 'success');
      } catch (err) {
        setStatus(curlStatus, 'Clipboard copy failed. Copy manually instead.', 'error');
      }
    });

    endpointPicker.addEventListener('change', (event) => {
      const def = endpointDefinitions.find(item => item.id === event.target.value);
      applyEndpoint(def);
    });

    requestMethod.addEventListener('change', () => {
      updateRequestBodyPlaceholder();
      updateCurlCommand();
    });

    requestEndpoint.addEventListener('input', updateCurlCommand);

    requestBodyField.addEventListener('input', () => {
      if (requestBodyField.value.trim() !== (state.lastAppliedSample || '')) {
        state.lastAppliedSample = '';
      }
      updateCurlCommand();
    });

    loginForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      resetStatus(loginStatus);
      loginSubmitBtn.disabled = true;
      setStatus(loginStatus, 'Sending request…');
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const baseUrl = getBaseUrl();
      try {
        const response = await fetch(`${baseUrl}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const payload = await response.json().catch(() => ({}));
        loginOutput.textContent = prettify(payload);
        if (!response.ok) {
          setStatus(loginStatus, `Request failed (${response.status})`, 'error');
          setToken('');
        } else if (payload && payload.token) {
          setToken(payload.token);
          state.baseUrl = baseUrl;
          baseUrlInput.value = baseUrl;
          setStatus(loginStatus, 'Authenticated successfully', 'success');
        } else {
          setToken('');
          setStatus(loginStatus, 'Login succeeded but token missing', 'error');
        }
      } catch (err) {
        loginOutput.textContent = String(err);
        setStatus(loginStatus, 'Network error – check the server', 'error');
        setToken('');
      } finally {
        loginSubmitBtn.disabled = false;
      }
    });

    requestForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      resetStatus(requestStatus);
      requestSubmitBtn.disabled = true;
      setStatus(requestStatus, 'Sending request…');
      const endpoint = requestEndpoint.value.trim() || '/api/me';
      const method = (requestMethod.value || 'GET').toUpperCase();
      const baseUrl = getBaseUrl();
      const url = new URL(endpoint, baseUrl);
      const headers = new Headers();
      if (state.token) {
        headers.set('Authorization', `Bearer ${state.token}`);
      }
      const methodAllowsBody = methodSupportsBody(method);
      const bodyText = requestBodyField.value.trim();
      let requestBody;
      if (methodAllowsBody && bodyText) {
        try {
          JSON.parse(bodyText);
          headers.set('Content-Type', 'application/json');
          requestBody = bodyText;
        } catch (err) {
          setStatus(requestStatus, 'Body must be valid JSON.', 'error');
          requestOutput.textContent = 'Invalid JSON body – request not sent.';
          requestSubmitBtn.disabled = false;
          return;
        }
      }
      try {
        const response = await fetch(url.toString(), {
          method,
          headers,
          body: methodAllowsBody && bodyText ? requestBody : undefined
        });
        const text = await response.text();
        let parsed;
        try {
          parsed = JSON.parse(text);
        } catch (err) {
          parsed = text || '';
        }
        requestOutput.textContent = prettify(parsed);
        if (!response.ok) {
          setStatus(requestStatus, `Request failed (${response.status})`, 'error');
        } else {
          setStatus(requestStatus, 'Request succeeded', 'success');
        }
      } catch (err) {
        requestOutput.textContent = String(err);
        setStatus(requestStatus, 'Network error – check the server', 'error');
      } finally {
        requestSubmitBtn.disabled = false;
        updateCurlCommand();
      }
    });
  </script>
</body>
</html>
